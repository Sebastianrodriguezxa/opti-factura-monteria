<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizar Factura - OptiFactura Montería</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="/"><img src="img/logo.svg" alt="OptiFactura" width="30" height="30">
                OptiFactura</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span
                    class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/dashboard"><i
                                class="bi bi-speedometer2 me-1"></i>Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/analizar"><i
                                class="bi bi-search me-1"></i>Analizar</a></li>
                    <li class="nav-item"><a class="nav-link" href="/tarifas"><i
                                class="bi bi-receipt me-1"></i>Tarifas</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"><i
                                class="bi bi-person-circle"></i> <span id="usuario-nombre">Usuario</span></a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/perfil"><i class="bi bi-person me-2"></i>Mi Perfil</a>
                            </li>
                            <li><a class="dropdown-item" href="/configuracion"><i
                                        class="bi bi-gear me-2"></i>Configuración</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i
                                        class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h2 class="mb-4"><i class="bi bi-search me-2"></i>Analizar Factura</h2>
                <div id="alert-container"></div>

                <!-- Upload Form -->
                <div class="card mb-4" id="upload-section">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-cloud-upload me-2"></i>Subir Factura</h5>
                    </div>
                    <div class="card-body">
                        <form id="analisis-form" enctype="multipart/form-data">
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="proveedor" class="form-label">Proveedor</label>
                                    <select class="form-select" id="proveedor" required>
                                        <option value="">Seleccionar proveedor</option>
                                        <option value="afinia">Afinia (Electricidad)</option>
                                        <option value="veolia">Veolia (Agua)</option>
                                        <option value="surtigas">Surtigas (Gas)</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="estrato" class="form-label">Estrato Socioeconómico</label>
                                    <select class="form-select" id="estrato" required>
                                        <option value="">Seleccionar estrato</option>
                                        <option value="1">Estrato 1</option>
                                        <option value="2">Estrato 2</option>
                                        <option value="3">Estrato 3</option>
                                        <option value="4">Estrato 4</option>
                                        <option value="5">Estrato 5</option>
                                        <option value="6">Estrato 6</option>
                                    </select>
                                </div>
                            </div>

                            <div class="upload-area mb-4" id="upload-area"
                                onclick="document.getElementById('factura-input').click()">
                                <i class="bi bi-cloud-arrow-up" style="font-size:3rem;color:var(--primary-light);"></i>
                                <h5 class="mt-3">Arrastra tu factura aquí o haz clic para seleccionar</h5>
                                <p>Formatos aceptados: JPG, PNG, PDF (máx. 10MB)</p>
                                <input type="file" id="factura-input" name="factura" accept=".jpg,.jpeg,.png,.pdf"
                                    style="display:none;">
                            </div>

                            <div id="file-preview" style="display:none;"
                                class="alert alert-info d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="bi bi-file-earmark-check me-2"></i>
                                    <span id="file-name"></span>
                                    <small class="text-muted ms-2" id="file-size"></small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile()">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg w-100" id="analizar-btn">
                                <i class="bi bi-cpu me-2"></i>Analizar Factura
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Results -->
                <div id="results-section" style="display:none;">
                    <div class="card mb-4">
                        <div class="card-header bg-primary">
                            <h5 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Resultado del Análisis</h5>
                        </div>
                        <div class="card-body" id="results-content"></div>
                    </div>
                </div>

                <!-- Historial -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Historial de Análisis</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Proveedor</th>
                                        <th>Monto</th>
                                        <th>Anomalías</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-historial">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-3">Cargando historial...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem("token");
        const usuario = JSON.parse(localStorage.getItem("usuario") || "null");
        if (!token) { window.location.href = "/login.html"; }
        if (usuario) {
            document.getElementById("usuario-nombre").textContent = `${usuario.nombre} ${usuario.apellido}`;
        }
        window.logout = () => { localStorage.removeItem("token"); localStorage.removeItem("usuario"); window.location.href = "/login.html"; };

        // File handling
        const uploadArea = document.getElementById("upload-area");
        const fileInput = document.getElementById("factura-input");

        fileInput.addEventListener("change", function () {
            if (this.files.length > 0) {
                const file = this.files[0];
                document.getElementById("file-name").textContent = file.name;
                document.getElementById("file-size").textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                document.getElementById("file-preview").style.display = "flex";
                uploadArea.classList.add("border-primary");
            }
        });

        uploadArea.addEventListener("dragover", (e) => { e.preventDefault(); uploadArea.classList.add("border-primary"); });
        uploadArea.addEventListener("dragleave", () => { if (!fileInput.files.length) uploadArea.classList.remove("border-primary"); });
        uploadArea.addEventListener("drop", (e) => {
            e.preventDefault();
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event("change"));
            }
        });

        window.removeFile = () => {
            fileInput.value = "";
            document.getElementById("file-preview").style.display = "none";
            uploadArea.classList.remove("border-primary");
        };

        // Submit form
        document.getElementById("analisis-form").addEventListener("submit", async function (e) {
            e.preventDefault();
            const btn = document.getElementById("analizar-btn");
            const alertContainer = document.getElementById("alert-container");

            if (!fileInput.files.length) {
                alertContainer.innerHTML = '<div class="alert alert-danger">Por favor selecciona un archivo de factura</div>';
                return;
            }

            const formData = new FormData();
            formData.append("factura", fileInput.files[0]);
            formData.append("proveedor", document.getElementById("proveedor").value);
            formData.append("estrato", document.getElementById("estrato").value);

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analizando factura...';
            alertContainer.innerHTML = "";

            try {
                const response = await fetch("/api/analisis/factura", {
                    method: "POST",
                    headers: { Authorization: `Bearer ${token}` },
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    mostrarResultados(result.data);
                    cargarHistorial();
                } else {
                    alertContainer.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>${result.message || 'Error al analizar la factura'}</div>`;
                }
            } catch (error) {
                alertContainer.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Error de conexión</div>';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-cpu me-2"></i>Analizar Factura';
            }
        });

        function mostrarResultados(data) {
            const section = document.getElementById("results-section");
            const content = document.getElementById("results-content");

            let html = `
                <div class="row g-3 mb-3">
                    <div class="col-sm-4 text-center">
                        <h4 class="text-primary">$${(data.montoTotal || 0).toLocaleString('es-CO')}</h4>
                        <small class="text-muted">Monto Facturado</small>
                    </div>
                    <div class="col-sm-4 text-center">
                        <h4 class="text-success">$${(data.montoEsperado || 0).toLocaleString('es-CO')}</h4>
                        <small class="text-muted">Monto Esperado</small>
                    </div>
                    <div class="col-sm-4 text-center">
                        <h4 class="${(data.diferencia || 0) > 0 ? 'text-danger' : 'text-success'}">
                            ${(data.diferencia || 0) > 0 ? '+' : ''}${(data.diferencia || 0).toFixed(1)}%
                        </h4>
                        <small class="text-muted">Diferencia</small>
                    </div>
                </div>`;

            if (data.anomalias && data.anomalias.length > 0) {
                html += '<h6 class="mt-3 mb-2"><i class="bi bi-exclamation-triangle me-2 text-warning"></i>Anomalías Detectadas</h6>';
                html += data.anomalias.map(a => `
                    <div class="alert alert-warning p-2 mb-2">
                        <strong>${a.tipo || 'Anomalía'}:</strong> ${a.descripcion || a.mensaje || ''}
                        ${a.diferencia ? `<br><small>Diferencia: ${a.diferencia}%</small>` : ''}
                    </div>
                `).join("");
            } else {
                html += '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>No se detectaron anomalías. Tu factura parece correcta.</div>';
            }

            content.innerHTML = html;
            section.style.display = "block";
            section.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        // Load historial
        async function cargarHistorial() {
            try {
                const response = await fetch("/api/analisis/historial?limite=10", {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (response.ok) {
                    const result = await response.json();
                    const analisis = result.data?.analisis || [];
                    const tbody = document.getElementById("tabla-historial");
                    if (analisis.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">No hay análisis previos</td></tr>';
                        return;
                    }
                    tbody.innerHTML = analisis.map(a => `
                        <tr>
                            <td>${new Date(a.createdAt).toLocaleDateString('es-CO')}</td>
                            <td>${a.proveedor || 'N/A'}</td>
                            <td>$${(a.montoTotal || 0).toLocaleString('es-CO')}</td>
                            <td>${(a.anomaliasDetectadas || 0) > 0 ? `<span class="badge bg-warning">${a.anomaliasDetectadas}</span>` : '<span class="badge bg-success">0</span>'}</td>
                        </tr>
                    `).join("");
                }
            } catch (error) {
                console.error("Error al cargar historial:", error);
            }
        }

        cargarHistorial();
    </script>
</body>

</html>